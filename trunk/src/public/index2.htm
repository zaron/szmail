<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>szMail</title>
<link rel="stylesheet" href="css/layout2.css" />

<script type="text/javascript" src="lib/yabble.js"></script>
<script type="text/javascript" src="lib/jquery.js"></script>
<script type="text/javascript" src="lib/jquery.tmpl.js"></script>
<script type="text/javascript" src="folders.js"></script>
<script type="text/javascript" src="mails.js"></script>


<script type="text/javascript" src="navigator.js"></script>

<script type="text/javascript">
function loadTemplate (id, url) {
	// TODO: store which templates are already loaded and compiled then decide about loading.
	var data = $.ajax({ type: "GET", url: url, async: false }).responseText;
	return $.template(id, data);
};

var templates = {};
function insertTemplateSet(set) {
	for (var id in set.templates) {
		if(templates[set.templates[id]]) continue;
		templates[set.templates[id]] = loadTemplate(set.templates[id],'tpl/' + set.templates[id] + '.tpl');
	};
	set.insert(templates[set.templates[0]]);
};

function View (options) {
	var loaded = false;
	var anchor = null;
	var placeholders = {};
	
	this.show = function () {
		if(loaded) {
			anchor.show();

		} else {
			insertTemplateSet({
				templates : options.templates,
				insert    : function (tmpl) {
					anchor = options.insert(tmpl);
					anchor.hide();
					anchor.show('slow');
					loaded = true;
				}
			});
		}
		for(var id in placeholders) {
			placeholders[id].show();
		}
	};
	
	this.hide = function () {
		if(!loaded) {
			alert('View not loaded yet!');
			return;
		}
		anchor.hide('slow');
	};
	
	this.setPlaceholder = function (name, placeholder) {
		if(placeholders[name] && placeholders[name] != placeholder) placeholders[name].hide();
		placeholders[name] = placeholder;
	};
};

var TwoColumnsPerspective = new View({
	templates : ['base/layout','base/header','base/aside','base/content','base/footer','base/universalbar','base/accounts'],
	insert    : function (tmpl) {
		return $.tmpl(tmpl).appendTo($('body'));
	}
});


var SettingsSidebar = new View({
	templates : ['settings/sidebar'],
	insert    : function (tmpl) {
		return $.tmpl(tmpl).appendTo($('#aside'))
	}
});

var MailboxSidebar = new View({
	templates : ['mail/sidebar'],
	insert    : function (tmpl) {
		return $.tmpl(tmpl).appendTo($('#aside'))
	}
});




$(function () {
	
	$(window).bind('hashchange', function(event) {
		//Navigator.update();
	});

	TwoColumnsPerspective.setPlaceholder('aside',SettingsSidebar);
	TwoColumnsPerspective.show();

	$(window).click(function () {
		TwoColumnsPerspective.setPlaceholder('aside',MailboxSidebar);
		TwoColumnsPerspective.show();
	});
	
});


</script>
</head>
<body></body>
</html>